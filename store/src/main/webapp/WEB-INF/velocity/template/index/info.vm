#parse( "./include/variable.vm" )
<div class="nav-top">
    <div class="">
        <div class="nav-content">
            <div class="table-jqgrid">
                <!--这里放jqgrid-->
                <table id="list" style="width: 95%;" form="search_form"></table>
                <div id="pager"></div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $("#startTime").datetimepicker({
            format: "dd MM yyyy - hh:ii",
            autoclose: true,
            pickerPosition: "bottom-left"
        }).on("click",function(ev){
            $("#startTime").datetimepicker("setEndDate", $("#endTime").val());
        });

        $("#endTime").datetimepicker({
            format: "dd MM yyyy - hh:ii",
            autoclose: true,
            pickerPosition: "bottom-left"
        }).on("click",function(ev){
            $("#endTime").datetimepicker("setStartDate", $("#startTime").val());
        });
        setTimeout(function () {
            var topWin = window.top.document;
            var bodyclass = $(topWin).find("body").attr("class");
            //if(bodyclass){
            $('body').attr("class", bodyclass);
            //}
        }, 0);
        fixBtns();
        $("#list")
                .jqGrid(
                {
                    url: '$ctx/index/tableList',
                    datatype: "local",
                    colNames: ["餐桌编号", "就餐人数","就餐时间","订单号", "点菜(功能暂未开放)", "结账", "下一位"],
                    colModel: [
                        {
                            name: 'tableCode',
                            index: 'tableCode',
                            align: "center",
                            width: "45px",
//                            key: true
                        }, {
                            name: 'peopleCount',
                            index: 'peopleCount',
                            align: "center",
                            width: "50px",
                            minWidth: "45px",
                        },
                        {
                            name: 'createTime',
                            index: 'createTime',
                            align: "center",
                            width: "45px",
                        },
                        {
                            name: 'orderId',
                            index: 'orderId',
                            align: "center",
                            width: "45px",
                        },
                        {
                            name: 'order',
                            index: 'order',
                            align: "center",
                            width: "60px",
                            formatter : function(cellval, optss,
                                                 rowObject, action) {
                                return '点菜<br>删菜<br>查看'
//                                return '<a href="javascript:orderDash()" class="row_btn">点菜</a><br>'
//                                        +'<a href="javascript:deleteDash('+rowObject['tableCode']+')" class="row_btn">删菜</a><br>'
//                                        +'<a href="javascript:checkOrder('+rowObject['tableCode']+')" class="row_btn">查看</a>';
                            }
                        },
                        {
                            name: 'checkOut',
                            index: 'checkOut',
                            align: "center",
                            width: "60px",
                            formatter : function(cellval, optss,
                                                 rowObject, action) {
                                var result = '<a href="javascript:createOrder(\''
                                        + rowObject['tableCode']
                                        + '\')" class="row_btn">生成订单</a><br>'
                                        + '<a href="javascript:checkOut(\''
                                        + rowObject['tableCode']
                                        + '\')" class="row_btn">结账</a>';
                                var count = rowObject['peopleCount']
                                return (count <= 0) ? '<a href="javascript:takeSeat(\''
                                        + rowObject['tableCode']
                                        + '\')" class="row_btn">就座</a><br>'
                                        + result : result
                            }
                        },
                        {
                            name: 'nextOne',
                            index: 'nextOne',
                            align: "center",
                            width: "60px",
                            formatter : function(cellval, optss,
                                                 rowObject, action) {
                                var count = rowObject['peopleCount'];
                                var tableCode = rowObject['tableCode'];
                                return (count <= 0) ? '<button type="button" id="queueUpBtn" onclick="nextCustomerOne(\''+tableCode+'\')"><i class="icon-search align-top bigger-125"></i>下一位</button>' : '下一位';
                            }
                        }
                    ],
//                    rowNum: 15,
//                    rowList: [15, 30, 50],
                    pager: '#pager',
                    height: 'auto',
                    multiselect: true,
                    viewrecords: true,
                    sortorder: "desc",
                    mtype: "POST",
                    deleteKeys: ["id"],
                    width: "85%",
                    shrinkToFit: true,
                    autowidth: true,
//			caption : "政策列表",
                    editurl: "add",
                    gridComplete: function () {
                        //set online publish effect ,the row backgroud-color is green
                        var onlineRows = $("#list tr td[aria-describedby=list_status][title='已发布']");
                        $.each(onlineRows, function (i, item) {
                            var startTime = $(item).parent().find("[aria-describedby=list_startTime] div").html();
                            if (isRuleEffect(startTime)) {
                                $(item).parent().addClass('onlinestatus');
                            }
                        });

                        if ($("#showOverdue").attr("checked") == "checked") {
                            var overdueRows = $("#list tr td[aria-describedby=list_status][title='过期']");
                            overdueRows.parent().addClass('overduestatus');
                        }

                    }
                });

        $("#list").jqGrid('navGrid', '#pager', {
            edit: false,
            add: false,
            del: false
        });
        $("#list").jqGrid('setGridParam', {
            datatype: 'json'
        });

        $("#list").trigger('reloadGrid');

        $("input:checkbox").click(function () {
            var checked = $(this).attr("checked");
            if (checked || checked == "checked") {
                $(this).attr("checked", false);
            } else
                $(this).attr("checked", true);
        });

        $("#time_select a").click(function () {
            var value = $(this).attr("value");
            switch (parseInt(value)) {
                case 1:
                    var day = getDateStr(0, '/');
                    $("#startTime").val(day);
                    break;
                case 2:
                    var day = getDateStr(1, '/');
                    $("#startTime").val(day);
                    break;
                case 3:
                    var day = getDateStr(2, '/');
                    $("#startTime").val(day);
                    break;
                case 4:
                    var startDay = getDateStr(1, '/');
                    var endDay = getDateStr(7, '/');
                    $("#startTime").val(startDay);
                    $("#endTime").val(endDay);
                    break;
                case 5:
                    $("#startTime").val("");
                    $("#endTime").val("");
                    break;
            }
        });

        $("#showOverdue").click(function () {
            $("#search_btn").click();
        });
    });


    $(window).bind('resize', function() {
        $("#list").setGridWidth($(window).width()-10);
    }).trigger('resize');

    //点菜
    function orderDash(){

    }

    //查看已点菜单
    function checkOrder(tableCode){

    }

    //删除部分菜品
    function deleteDash(tableCode){

    }

    //就坐
    function takeSeat(tableCode){
        var message = '<form><label>入座人数:</label><input type="text" class="form-control" placeholder="入座人数" name="countOfPeople"></form>';
        var title = " 入座"
        BootstrapDialog.confirm(title,message, function(){
            $.post("$ctx/index/takeSeat", {
                tableCode: tableCode,
                count: $("input[name='countOfPeople']").val()
            }, function (res) {
                if(res['success'] == "success"){
                    showInfo("成功");
                    return
                }
                $("#list").trigger('reloadGrid');
            }, "json");
        });
        $("#list").trigger('reloadGrid');
    }

    //生成订单
    function createOrder(tableCode){
//        我不知道内容
        var message = '<form id="createOrder"><label>菜品消费金额:</label><input type="text" class="form-control" name="foodPrice"><br><label>酒水消费金额:</label><input type="text" class="form-control" name="drinkPrice"></form>';
        var title = " 生成订单"
        BootstrapDialog.confirm(title,message, function(){
            $.post("$ctx/index/createOrder", {
                    tableCode: tableCode,
                    foodPrice: $("input[name='foodPrice']").val(),
                    drinkPrice: $("input[name='drinkPrice']").val()
            }, function (res) {
                    if(res['success'] == "success"){
                        showInfo("生成订单成功");
                        $("#list").trigger('reloadGrid');
                        return
                    }
                }, "json");
            }
        );
    }

    //结账
    function checkOut(tableCode){
        var result;
        $.ajax({
            url: '$ctx/index/checkOrder',
            type: 'post',
            data: {
                tableCode: tableCode
            },
            async: false,
            dataType: 'json',
            success: function (data) {
                result = data;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                result = XMLHttpRequest.responseText;
            }
        });
        if(result['success']=='false'){
            //创建订单并直接结账
        }else{

        }

//        我不知道内容
        var message = '<form><label>消费总金额:</label><input type="text" class="form-control" placeholder="输入金额"></form>';
        var title = " 结账"
        BootstrapDialog.confirm(title,message, function() {
        });
        $("#list").trigger('reloadGrid');
    }


    function getQueueAjax(tableCode) {
        $.ajax({
            url: '$ctx/index/nextOne',
            type: 'post',
            data: {
                tableCode: tableCode
            },
            dataType: 'json',
            success: function (data) {
                if(data['success'] == "false"){
                    $("#priceresult7").html("当前没有排队的人!");
                }else {
                    $("#priceresult7").html('编号:' + data['result']['lineCode'] + ",电话:" + data['result']['phone']);
                }
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                $("#priceresult7").html(XMLHttpRequest.responseText);
            }
        });
    }

    function getQueueSync(tableCode){
        var result;
        $.ajax({
            url: '$ctx/index/nextOne',
            type: 'post',
            data: {
                tableCode: tableCode
            },
            async: false,
            dataType: 'json',
            success: function (data) {
                result = data;
            },
            error: function (XMLHttpRequest, textStatus, errorThrown) {
                result = XMLHttpRequest.responseText;
            }
        });
        return result;
    }

    //下一位∂
    function nextCustomerOne(tableCode){
        var res = getQueueSync(tableCode);
        if(res['success'] == "false"){
            showInfo("当前没有排队的人!");
            return
        }else{
            var message = '<h1>获取被限购的身份证数据</h1>'
                    +'<div class="nav-content">'
                    +'<form id="form7" method="post">'
                    +'<table cellpadding="0" cellspacing="0">'
                    +'<tr>'
                    +'<td>'
                    +'<input type="text" name="tableCode" value="\''+tableCode+'\'">'
                    +'</td>'
                    +'<td>'
                    +'<input type="button" onclick="getQueueAjax(\''+tableCode+'\')" id="getLimitedIdentity" class="btn btn-success" value="提交" style="padding: 4px 62px; margin-left: 5px;" />'
                    +'</td>'
                    +'</tr>'
                    +'</tr>'
                    +'</table>'
                    +'</form>'
                    +'</div>'
                    +'<h1>返回结果</h1>'
                    +'<div id="priceresult7" class="nav-content">'+'编号:' + res['result']['lineCode'] + ",电话:" + res['result']['phone']+'</div>';
            var title = "下一位"
            BootstrapDialog.confirm(title,message, function() {
                $.post("$ctx/index/takeSeat", {
                    tableCode: tableCode,
                    count: res['result']['waitingNumber']
                }, function (res) {
                    if(res['success'] == "success"){
                        showInfo("成功");
                        $("#list").trigger('reloadGrid');
                        return
                    }
                }, "json");
            });
        }
    }
</script>
